@page
@model AplicatieLicenta.Pages.Users.StartUserModel
@{
    ViewData["Title"] = "Cluburi de lectură";
}

@if (Model.CluburiRelevante.Any())
{
    <h2>Cluburi de lectură pentru categoria ta de vârstă: <strong>@Model.CategorieVarsta</strong></h2>

    @foreach (var club in Model.CluburiRelevante)
    {
        var membru = club.MembriClub.FirstOrDefault(m => m.IdUtilizator == Model.UserId);

        <div class="club-card">
            <h5>@club.Nume</h5>
            <p><strong>Descriere:</strong> @club.Descriere</p>
            <p><strong>Categorie:</strong> @club.CategorieVarsta</p>

            @if (membru != null)
            {
                if (membru.Status == "Aprobat")
                {
                    <button class="chat-open-btn" onclick="openChat('@club.Nume', @club.IdClub)">
                        Alătură-te discuțiilor despre cărțile preferate!
                    </button>
                }
                else if (membru.Status == "In asteptare")
                {
                    <span class="pending-msg">Cererea ta a fost trimisă către admin.</span>
                }
            }
            else
            {
                <form method="post" asp-page-handler="Join">
                    <input type="hidden" name="clubId" value="@club.IdClub" />
                    <button type="submit" class="chat-open-btn">Intră acum în club!</button>
                </form>
            }
        </div>
    }
}
else
{
    <p>Momentan nu există cluburi de lectură pentru categoria ta de vârstă.</p>
}

<div id="chat-box" class="hidden">
    <div class="chat-header">
        <span id="chat-title">Discuție Club</span>
        <button onclick="toggleChat()">&times;</button>
    </div>
    <div class="chat-body" id="chat-messages"></div>
    <div class="chat-footer">
        <input id="messageInput" type="text" placeholder="Scrie un mesaj..." />
        <button onclick="sendMessage()">Trimite</button>
        <button onclick="startRecording()">Start</button>
        <button onclick="stopRecording()">Stop</button>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/designStartUser.css" />
}

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        let connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        let currentClubId = 0;
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob = null;

        let userId = @Model.UserId;
        let userEmail = "@Model.UserEmail";

        connection.start()
            .then(() => console.log("✅ Conectat la SignalR"))
            .catch(err => console.error("❌ Eroare la conectare:", err));

        connection.on("ReceiveMessage", (email, mesaj, ora, audioUrl) => {
            addMessage(email, mesaj, ora, audioUrl);
        });

        function openChat(clubName, clubId) {
            currentClubId = clubId;
            document.getElementById("chat-title").textContent = "Discuție în " + clubName;
            document.getElementById("chat-box").classList.remove("hidden");
            document.getElementById("chat-box").classList.add("chat-box-visible");

            loadMesaje(clubId);
            connection.invoke("JoinClub", clubId).catch(err => console.error(err));
        }

        function toggleChat() {
            const chatBox = document.getElementById("chat-box");
            chatBox.classList.add("hidden");
            chatBox.classList.remove("chat-box-visible");
        }

        function addMessage(email, mesaj, ora, audioUrl = null) {
            const chatBody = document.getElementById("chat-messages");
            const mesajNou = document.createElement("div");

            if (audioUrl) {
                mesajNou.innerHTML = `<strong>${email}</strong> (${ora}):<br>
                            <audio controls>
                                <source src="${audioUrl}" type="audio/webm">
                                Browserul tău nu suportă fișiere audio.
                            </audio>`;
            } else {
                mesajNou.innerHTML = `<strong>${email}</strong> (${ora}): ${mesaj}`;
            }

            chatBody.appendChild(mesajNou);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function loadMesaje(idClub) {
            fetch('/Users/StartUser?handler=IncarcaMesaje&idClub=' + idClub)
                .then(res => res.json())
                .then(data => {
                    const chatBody = document.getElementById("chat-messages");
                    chatBody.innerHTML = "";
                    data.forEach(msg => {
                        addMessage(msg.email, msg.continut, msg.dataTrimiterii, msg.audioUrl);
                    });
                })
                .catch(err => console.error("❌ Eroare la încărcarea mesajelor:", err));
        }

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    document.getElementById("messageInput").placeholder = "🎙️ Înregistrare în curs...";

                    mediaRecorder.ondataavailable = e => {
                        audioChunks.push(e.data);
                    };

                    mediaRecorder.onstop = () => {
                        recordedBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });

                        console.log("📦 Înregistrare completă. Dimensiune blob:", recordedBlob.size);

                        document.getElementById("messageInput").placeholder = "Scrie un mesaj...";
                    };

                    mediaRecorder.start();
                    console.log("▶️ Înregistrare pornită...");
                })
                .catch(err => console.error("❌ Acces la microfon refuzat:", err));
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
                console.log("⏹️ Înregistrare oprită");
            }
        }

        function sendMessage() {
            const input = document.getElementById("messageInput");
            const mesaj = input.value.trim();

            // ✅ Trimitere text
            if (mesaj !== "") {
                connection.invoke("SendMessage", currentClubId, userId, userEmail, mesaj)
                    .catch(err => console.error("❌ Eroare la trimitere text:", err));
                input.value = "";
                return;
            }

            // ✅ Trimitere vocal
            if (recordedBlob && recordedBlob.size > 0) {
                const formData = new FormData();
                formData.append("vocal", recordedBlob, "voce.webm");
                formData.append("idClub", currentClubId);
                formData.append("userId", userId);
                formData.append("userEmail", userEmail);

                fetch('/Users/StartUser?handler=Vocal', {
                    method: 'POST',
                    body: formData
                })
                    .then(r => r.text())
                    .then(fileName => {
                        if (!fileName || fileName.trim().length < 5) {
                            console.error("⚠ Răspuns invalid de la server:", fileName);
                            return;
                        }

                        const audioUrl = `/vocale/${fileName}`;
                        connection.invoke("SendVocal", currentClubId, userId, userEmail, audioUrl)
                            .catch(err => console.error("❌ Eroare la SignalR vocal:", err));

                        recordedBlob = null;
                        audioChunks = [];
                    })
                    .catch(err => console.error("❌ Eroare la upload vocal:", err));

                return;
            }

            alert("Scrie un mesaj sau înregistrează ceva înainte de a trimite.");
        }
    </script>
}
